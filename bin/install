#!/bin/bash

if bash "$MOPM_ROOT/bin/verification" "$1" > /dev/null 2>&1 ; then
  echo "The package is already installed" 1>&2
  exit 1
elif ! bash "$MOPM_ROOT/bin/list" | grep -E "^$1$" > /dev/null 2>&1 ; then
  echo "The package is not exist" 1>&2
  exit 2
fi

package_path="$MOPM_ROOT/definitions/$MOPM_ARCHITECTURE-$MOPM_PLATFORM-$1.mopm"

need_privilege="$(grep -e '^#mopm privilege: ' "$package_path" | cut -d ':' -f2- | sed 's/ //g' |  sed -e "s/[\r\n]\+//g")"

if [ "$need_privilege" = "root" ] && [ "$MOPM_PRIVILEGE" = unroot ]; then
  echo "Please excute installation with root" 1>&2
  exit 3
elif [ "$need_privilege" = "never" ] && [ "$MOPM_PRIVILEGE" = root ]; then
  echo "Please excute installation with not root" 1>&2
  exit 3
elif [ "$need_privilege" != "root" ] && [ "$need_privilege" != "never" ] && [ "$need_privilege" != "unnecessary" ]; then
  echo "The package is unknown privilege" 1>&2
  exit 3
fi
  
exec bash "$package_path"
